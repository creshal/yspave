#! /usr/bin/env python
# (c) Samuel Vincent Creshal <samuel@creshal.de> 2014
import argparse,getpass,sys, readline, os
from yspave import pave, crypto, util, pwgen, commands
from colorama import Fore as fg

actions = '''scrypt based password manager.

Actions:
	new	Prompts for title/description and generates a new password
		with supplied entropy (default: %i bit)
	add	Prompts for title, description and password
	edit	Edits entry with supplied query ID
	del	Deletes entry with supplied query ID
	get	Searches the DB for the supplied query string
		Shows the whole database if no query is supplied. This can take a while.
	pwgen	Generate a random password with supplied entropy and print it
		(default: %i bit)
	import	Imports passwords from a CSV file.
		Column order is title, description, password
		The format is the default Excel/Calc format (comma separation,
		quoting optional).
	migrate	Re-syncs the database, migrating it to new database formats
		and doing other maintenance if necessary.
		This is also done automatically on all writing operations (edit/add/del).

Password generator options:
	x, xkcd		Random word generator as per XKCD 936
	a, alnum	Random letters/numbers
	p, print	Random characters (letters, digits, punctuation)

'''%(pave.PaveCfg.pwgen_bits,pave.PaveCfg.pwgen_bits)
examples = '''Examples:
	yspavectl pwgen 192
		Generates a random alphanumeric password and prints it

	yspavectl -m x pwgen
		Generates a random "sentence"

	yspavectl get foobar
		Shows all passwords matching "foobar" in their
		description or title

	yspavectl new
		Generates a new password and saves it together with
		supplied metadata

	yspavectl edit 3
		Edit the password with ID #3
'''

parser = argparse.ArgumentParser(prog=pave.appname,description=actions,formatter_class=argparse.RawTextHelpFormatter,epilog=examples)
parser.add_argument('--version', '-v', action='version', version='%(prog)s '+pave.appvers)
parser.add_argument('--file','-f', help='Database file',nargs='?',default=pave.db_filename)
parser.add_argument('--config-file','-c',help='Configuration file',nargs='?',default=pave.config_filename)
parser.add_argument('--pwgen-mode','-m',choices=['print','p','alnum','a','xkcd','x'],default='a',nargs='?')
parser.add_argument('action', choices=['migrate','new','add','edit','del','get','pwgen','import'], default=None,nargs='?')
parser.add_argument('query',default=None,nargs='?',help='ID for edit/del mode, search string for get mode')
args = parser.parse_args()

if os.path.exists (args.config_file):
	config = pave.PaveCfg (args.config_file, args.pwgen_mode)
else:
	if args.config_file == pave.config_filename: #implicitly create default file
		config = pave.PaveCfg (None, args.pwgen_mode)
	else: raise IOError ('Config file %s does not exist!'%args.config_file)

#This is a special case -- one-shot password generator, not operating on the database at all
if args.action == 'pwgen':
	print (pwgen.PwGen(config).mkpass (args.query))
	sys.exit (0)

while True:
	try:
		password = getpass.getpass ('Database password: ')
		db = crypto.PaveDB (password, args.file, config)
		del (password)
		break
	except EOFError:          sys.exit (0)
	except KeyboardInterrupt: sys.exit (1)
	except:pass

cmd = commands.Commands(config, db)

if args.action:
	#single command mode
	cmd.dispatch (args.action, args.query)
else:
	#interactive mode
	while True:
		try:
			action, query = map (lambda x: x.strip(), (util.prompt ('> ')+' ').split(' ',1))
			if not action: raise EOFError
		except EOFError:          sys.exit (0)
		except KeyboardInterrupt: sys.exit (1)

		if action in ['help','?']:
			print (actions+examples)
		else:
			cmd.dispatch (action, query)

